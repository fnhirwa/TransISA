name: Run Exhaustive Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  run-tests:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            name: ubuntu
          - os: macos-latest
            name: macos

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg lsb-release

          wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
          sudo add-apt-repository "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-19 main"
          sudo apt-get update

          sudo apt-get install -y \
            cmake ninja-build \
            llvm-19 llvm-19-dev llvm-19-tools \
            clang-19 clang-tools-19 \
            lld-19 libc++-19-dev libc++abi-19-dev

          echo "CC=/usr/bin/clang-19" >> $GITHUB_ENV
          echo "CXX=/usr/bin/clang++-19" >> $GITHUB_ENV
          echo "LLVM_DIR=/usr/lib/llvm-19/lib/cmake/llvm" >> $GITHUB_ENV
          echo "PATH=/usr/lib/llvm-19/bin:$PATH" >> $GITHUB_ENV

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install cmake ninja llvm@19

          LLVM_PREFIX="$(brew --prefix llvm@19)"
          SDKROOT="$(xcrun --sdk macosx --show-sdk-path)"

          echo "LLVM_PREFIX=${LLVM_PREFIX}" >> $GITHUB_ENV
          echo "SDKROOT=${SDKROOT}" >> $GITHUB_ENV

          echo "CC=${LLVM_PREFIX}/bin/clang" >> $GITHUB_ENV
          echo "CXX=${LLVM_PREFIX}/bin/clang++" >> $GITHUB_ENV
          echo "LLVM_DIR=${LLVM_PREFIX}/lib/cmake/llvm" >> $GITHUB_ENV
          echo "PATH=${LLVM_PREFIX}/bin:$PATH" >> $GITHUB_ENV

      - name: Verify toolchain
        run: |
          echo "CC = $CC"
          echo "CXX = $CXX"
          $CC --version

      - name: Configure CMake (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          rm -rf build
          cmake -B build -S . -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_C_COMPILER="$CC" \
            -DCMAKE_CXX_COMPILER="$CXX" \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_CXX_STANDARD_REQUIRED=ON

      - name: Configure CMake (macOS)
        if: runner.os == 'macOS'
        run: |
          rm -rf build
          cmake -B build -S . -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_C_COMPILER="$CC" \
            -DCMAKE_CXX_COMPILER="$CXX" \
            -DCMAKE_AR="$LLVM_PREFIX/bin/llvm-ar" \
            -DCMAKE_RANLIB="$LLVM_PREFIX/bin/llvm-ranlib" \
            -DCMAKE_OSX_SYSROOT="$SDKROOT" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=13.0 \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_CXX_STANDARD_REQUIRED=ON

      - name: Verify archive tools (macOS)
        if: runner.os == 'macOS'
        run: |
          cmake -LA -N build | grep CMAKE_AR
          cmake -LA -N build | grep CMAKE_RANLIB

      - name: Build
        run: |
          cmake --build build --verbose

      - name: Run tests
        run: |
          cd build
          ctest --output-on-failure --verbose
