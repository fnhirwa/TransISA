name: Run Exhaustive Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  run-tests:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        include:
          - os: ubuntu-latest
            target: x86_64
          - os: macos-latest
            target: arm64
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          
          # Add LLVM apt repository
          wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
          sudo add-apt-repository "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-19 main"
          sudo apt-get update
          
          # Install LLVM 19 and dependencies
          sudo apt-get install -y cmake ninja-build \
            llvm-19 llvm-19-dev llvm-19-tools \
            clang-19 clang-tools-19 \
            lld-19 libc++-19-dev libc++abi-19-dev
          
          # Set environment variables
          echo "LLVM_DIR=/usr/lib/llvm-19/lib/cmake/llvm" >> $GITHUB_ENV
          echo "CC=/usr/bin/clang-19" >> $GITHUB_ENV
          echo "CXX=/usr/bin/clang++-19" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=/usr/lib/llvm-19/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV
          echo "PATH=/usr/lib/llvm-19/bin:$PATH" >> $GITHUB_ENV

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install cmake ninja llvm@19
          
          # Store LLVM path for easy reference
          LLVM_PREFIX=$(brew --prefix llvm@19)
          
          # Set up environment variables
          echo "LLVM_DIR=${LLVM_PREFIX}/lib/cmake/llvm" >> $GITHUB_ENV
          echo "CC=${LLVM_PREFIX}/bin/clang" >> $GITHUB_ENV
          echo "CXX=${LLVM_PREFIX}/bin/clang++" >> $GITHUB_ENV
          
          # Set compiler flags to use LLVM's libc++
          echo "CXXFLAGS=-stdlib=libc++" >> $GITHUB_ENV
          echo "LDFLAGS=-L${LLVM_PREFIX}/lib/c++ -Wl,-rpath,${LLVM_PREFIX}/lib/c++" >> $GITHUB_ENV
          
          # Set other required paths
          echo "PATH=${LLVM_PREFIX}/bin:$PATH" >> $GITHUB_ENV
          echo "DYLD_LIBRARY_PATH=${LLVM_PREFIX}/lib/c++:${LLVM_PREFIX}/lib:$DYLD_LIBRARY_PATH" >> $GITHUB_ENV

      - name: Verify LLVM Installation
        run: |
          echo "Using Clang version:"
          ${CC} --version
          echo "Using LLVM version:"
          llvm-config --version 2>/dev/null || echo "llvm-config not in PATH, checking specific location"
          if [ "$RUNNER_OS" == "Linux" ]; then
            /usr/lib/llvm-19/bin/llvm-config --version
          fi
          echo "LLVM Directory: ${LLVM_DIR}"

      - name: Configure CMake
        run: |
          cmake -B build -S . -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_FLAGS="${CXXFLAGS}" \
            -DCMAKE_C_FLAGS="${CFLAGS}" \
            -DCMAKE_EXE_LINKER_FLAGS="${LDFLAGS}" \
            -DCMAKE_SHARED_LINKER_FLAGS="${LDFLAGS}" \
            -DCMAKE_MODULE_LINKER_FLAGS="${LDFLAGS}"
        env:
          LLVM_DIR: ${{ env.LLVM_DIR }}
          CC: ${{ env.CC }}
          CXX: ${{ env.CXX }}
          CXXFLAGS: ${{ env.CXXFLAGS }}
          LDFLAGS: ${{ env.LDFLAGS }}
          PATH: ${{ env.PATH }}
          DYLD_LIBRARY_PATH: ${{ env.DYLD_LIBRARY_PATH }}
          LD_LIBRARY_PATH: ${{ env.LD_LIBRARY_PATH }}

      - name: Build Project
        run: |
          cmake --build build --config Debug --verbose
        env:
          PATH: ${{ env.PATH }}
          DYLD_LIBRARY_PATH: ${{ env.DYLD_LIBRARY_PATH }}
          LD_LIBRARY_PATH: ${{ env.LD_LIBRARY_PATH }}

      - name: Debug Build Artifacts (if build fails)
        if: failure()
        run: |
          echo "=== Checking for library files ==="
          ls -la build/src/Frontend/ 2>/dev/null || echo "Frontend directory not found"
          ls -la build/src/Codegen/ 2>/dev/null || echo "Codegen directory not found"
          ls -la build/src/Optimizer/ 2>/dev/null || echo "Optimizer directory not found"
          ls -la build/src/Utils/ 2>/dev/null || echo "Utils directory not found"
          
          echo "=== CMake configuration output ==="
          cat build/CMakeCache.txt 2>/dev/null || echo "CMakeCache.txt not found"

      - name: Run Tests
        run: |
          cd build
          ctest --output-on-failure --verbose
        env:
          PATH: ${{ env.PATH }}
          DYLD_LIBRARY_PATH: ${{ env.DYLD_LIBRARY_PATH }}
          LD_LIBRARY_PATH: ${{ env.LD_LIBRARY_PATH }}

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}
          path: build/Testing/